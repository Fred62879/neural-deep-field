
global:
    verbose: False
    print_shape: False
    activate_model_timer: False
    activate_trainer_timer: False
    dataloader_drop_last: False
    exp_name: 'test-ngp-nerf'
    use_gpu: True

    tasks: ['codebook_pretrain'] #,'recon_gt_spectra_during_train'] #,'save_pixel_values_during_train','save_redshift_during_train'] #,'recon_codebook_spectra_individ_during_train'] #,'save_qtz_weights_during_train']
    #tasks: ['pretrain_infer','recon_gt_spectra'] #,'save_qtz_weights'] #'recon_codebook_spectra'] #'save_pixel_values'] #'recon_codebook_spectra_individ'] #'save_redshift','recon_img','integrate_gt_spectra']

    #tasks: ['main_infer','recon_img']
    #tasks: ['main_infer','plot_redshift']
    #tasks: ['main_infer','recon_gt_spectra']
    #tasks: ['main_infer','plot_latent_embed']
    #tasks: ['main_infer','plot_gt_pixel_distrib']
    #tasks: ['main_infer','save_soft_qtz_weights']
    #tasks: ['main_infer','recon_codebook_spectra_individ']
    #tasks: ['main_infer','plot_embed_map','plot_redshift']
    #tasks: ['main_infer','plot_scaler','plot_redshift']
    #tasks: ['main_infer','recon_gt_spectra','log_soft_qtz_weights']
    #tasks: ['main_infer','recon_gt_spectra','log_pixel_value']
    #tasks: ['main_infer','recon_dummy_spectra','recon_gt_spectra']
    #tasks: ['main_infer','recon_gt_spectra','recon_codebook_spectra']
    #tasks: ['main_infer','recon_img','recon_synthetic_band','plot_embed_map']
    #tasks: ['main_infer','recon_img','plot_embed_map','plot_redshift','plot_scaler','save_qtz_weights']
    tasks: ['train'] #,'recon_gt_spectra_during_train','recon_img_during_train','save_redshift_during_train'] #,'recon_codebook_spectra_individ_during_train','save_qtz_weights_during_train','save_scaler_during_train'
    tasks: ['main_infer','recon_img'] #'recon_gt_spectra','save_redshift','recon_img'] #,'recon_codebook_spectra_individ']
    #tasks: ['test','recon_gt_spectra','save_redshift','recon_img'] #,'recon_codebook_spectra_individ']

optimizer:
    optimizer_type: 'adam'
    b1: 0.5
    b2: 0.999
    lr: 1e-4
    grid_lr: 1e-3
    codebook_lr: 1e-6
    codebook_pretrain_lr: 1e-4
    weight_decay: 1e-5
    grid_lr_weight: 100

net:
    nef_type: 'AstroHyperSpectralNerf' #'AstroNerf'
    model_redshift: True

    encode_wave: True
    wave_encode_method: 'positional_encoding'
    wave_multiplier: 20

    encode_coords: True
    coords_encode_method: 'positional_encoding'

embedder:
    coords_embed_bias: True
    coords_embed_dim: 200
    coords_embed_omega: 8
    coords_embed_sigma: 1.0
    coords_embed_seed: 2

    wave_embed_bias: True
    wave_embed_dim: 200
    wave_embed_omega: 1
    wave_embed_sigma: 1
    wave_embed_seed: 1

    wave_encoder_num_hidden_layers: 2
    wave_encoder_hidden_dim: 64
    wave_encoder_siren_first_w0: 6
    wave_encoder_siren_hidden_w0: 30
    wave_encoder_siren_seed: 0
    wave_encoder_siren_coords_scaler: 1
    wave_encoder_siren_last_linear: False

grid:
    grid_dim: 3
    grid_type: 'HashGrid'
    grid_interpolation_type: 'linear'
    grid_multiscale_type: 'cat'
    grid_feature_dim: 32
    grid_feature_std: 1
    grid_num_lods: 16 # max / min = b**l
    tree_type: 'geometric'
    min_grid_res: 6
    max_grid_res: 690 #160
    codebook_bitwidth: 20
    interpolation_align_corners: True

pretrain:
    codebook_pretrain_latent_dim: 32

decoder:
    decoder_num_hidden_layers: 1
    decoder_hidden_dim: 64
    decoder_layer_type: 'none'
    decoder_activation_type: "relu"
    decoder_skip_layers: []

    siren_seed: 0
    siren_first_w0: 24
    siren_hidden_w0: 6
    siren_coords_scaler: 8
    siren_last_linear: True

qtz:
    quantization_strategy: 'soft'
    quantization_calculate_loss: False # only if hard qtz
    qtz_latent_dim: 16
    qtz_num_embed: 50
    qtz_beta: 1
    qtz_seed: 8
    qtz_temperature_scale: 0.01

spatial_decod:
    decode_bias: True
    decode_scaler: True

    spatial_decod_hidden_dim: 64
    spatial_decod_num_hidden_layers: 1
    spatial_decod_output_dim: 16
    spatial_decod_layer_type: 'none'
    spatial_decod_activation_type: 'relu'
    spatial_decod_skip_layers: []

    scaler_decod_hidden_dim: 64
    scaler_decod_num_hidden_layers: 1
    scaler_decod_layer_type: 'none'
    scaler_decod_activation_type: 'relu'
    scaler_decod_skip_layers: []

    redshift_decod_hidden_dim: 64
    redshift_decod_num_hidden_layers: 1
    redshift_decod_layer_type: 'none'
    redshift_decod_activation_type: 'relu'
    redshift_decod_skip_layers: []

hyperspectral:
    hps_combine_method: 'concat'
    integration_method: 'dot_prod'
    intensify_intensity: False
    intensification_method: 'sinh'

trainer:
    trainer_type: 'AstroTrainer'
    log_dir: '/scratch/projects/vision/data/pdr3/output'

    plot_loss: True
    pixel_loss_cho: l1_mean
    spectra_loss_cho: l2_none #emd
    redshift_loss_cho: l2_mean
    num_epochs: 500
    batch_size: 2000
    pretrain_batch_size: 3200
    valid_every: -1
    render_tb_every: -1
    log_tb_every: -1
    log_cli_every: 100
    log_gpu_every: -1
    plot_grad_every: -1
    save_data_every: -1
    save_model_every: 100
    save_as_new: True

    train_with_all_pixels: False
    train_pixel_ratio: 1
    gpu_data: ['coords','pixels','weights','full_wave','wave','trans','nsmpl','spectra_sup_data','spectra_sup_plot_mask','spectra_sup_pixels','spectra_sup_redshift','spectra_semi_sup_redshift','spectra_val_redshift','masks','spectra_val_pixels','redshift','spectra_latents','gt_spectra_pixels','gt_spectra_redshift']

    batched_pretrain: True
    learn_spectra_within_wave_range: True
    codebook_pretrain_pixel_supervision: False

    decode_spatial_embedding: True
    quantize_latent: False
    quantize_spectra: True
    weight_train: False
    weight_by_wave_coverage: False

    spectra_beta: 1
    redshift_beta: 1
    pretrain_pixel_beta: 1
    pretrain_redshift_beta: 0.1
    spectra_supervision_start_epoch: 0

    uniform_sample_wave: True
    mixture_avg_per_band: True

    #### ******** Constantly modify ********
    pixel_supervision: True          # these two conflict
    train_spectra_pixels_only: False #  each other

    apply_gt_redshift: False         # -
    redshift_unsupervision: False    #  |- these three conflict each other
    redshift_semi_supervision: True  # -

    train_use_all_wave: False
    pretrain_use_all_wave: False
    train_num_wave_samples: 50
    pretrain_num_wave_samples: 100

    resume_train: False
    # resume_log_dir: '20230827-165135_128_main_train_densegrid_no_pretrain_500_epochs'

    pretrain_codebook: False         # these two conflict
    spectra_supervision: False      #  each other
    # pretrain_log_dir: '20230821-204243_pretrain_6000_spectra_50_codes_60k_epochs_convolved'
    # pretrained_model_name: 'model-ep60000-it0.pth'
    #### ***********************************

infer:
    inferrer_type: 'AstroInferrer'
    infer_batch_size: 70
    pretrain_infer_batch_size: 20
    infer_use_all_wave: True # enforced
    infer_last_model_only: True

    # recon img
    to_HDU: False
    # infer_log_dir: '20230827-215847_512_main_train_pe_no_pretrain_500_epochs'
    metric_options: ['mse','ssim','psnr']
    log_pixel_ratio: True

    recon_zoomed: False
    recon_cutout_patch_uids: ['981215']
    # each patch may have multiple cutouts
    recon_cutout_sizes: [ [64],[32] ]
    recon_cutout_start_pos: [ [[256,256]], [[86,188]] ]

    # recon spectra
    infer_selected: True
    pretrain_num_infer_upper_bound: 70
    test_num_infer_upper_bound: 10

    spectra_neighbour_size: 3

    flux_norm_cho: "linr"
    spectra_markers: [".",",","o","v","^","<",">","1","2","3","4","8","s","p","P","*","h","H","+","x","X","D","d","|","_"]
    mark_spectra: True
    plot_clipped_spectrum: True
    plot_spectrum_together: True
    plot_spectrum_with_gt: True
    plot_spectrum_with_recon: True
    plot_spectrum_with_trans: False
    average_neighbour_spectra: True
    infer_spectra_individually: False

    num_spectrum_per_fig: 35
    num_spectrum_per_row: 5 # 5 cols x 5 rows

dataset:
    dataset_num_workers: 0
    space_dim: 3

    dataset_type: 'astro'
    plot_img_distrib: True
    load_patch_data_cache: True
    dataset_path: '/scratch/projects/vision/data/pdr3'
    wave_range_fname: 'wave_range0.npy'
    train_coords_cho: "grid"
    normalize_coords: True
    gt_img_norm_cho: 'identity'   # identity/arcsinh/linear/clip(0,1)
    train_pixels_norm: 'identity' # identity/arcsinh/sinh/linear/clip(0,1)

patch_data:
    tracts: ['9812']
    patches: ['1,5']
    use_full_patch: False

    #### *** test patches ****
    test_tracts: []
    test_patches: []
    use_full_test_patch: False
    # TODO: add cutout config
    #### *********************

    #### **** below fields should be changed together ****
    patch_selection_cho: "64_cutout"

    # if don't use full patch, we can select cutout from tiles
    patch_cutout_num_rows: [64] #[512]
    patch_cutout_num_cols: [64] #[512]
    patch_cutout_start_pos: [[1917,754]] #[[1750,550]] #[[86,188]]
    #### *************************************************

trans_data:
    # num_bands: 1
    # sensor_collection_name: '1_i'
    # filter_ids: [2]
    # filters: [i]
    # sensors_full_name: [HSC-I]
    # plot_labels: ['i']
    # plot_colors: ['blue']
    # plot_styles: ['solid']

    num_bands: 3
    sensor_collection_name: '3_gri'
    filter_ids: [0,1,2]
    filters: [g,r,i]
    sensors_full_name: [HSC-G,HSC-R,HSC-I]
    plot_labels: ['g', 'r', 'i']
    plot_colors: ['green','red','blue']
    plot_styles: ['solid','solid','solid']

    # num_bands: 5
    # sensor_collection_name: '5_grizy'
    # filter_ids: [0,1,2,3,4]
    # filters: [g,r,i,z,y]
    # sensors_full_name: [HSC-G,HSC-R,HSC-I,HSC-Z,HSC-Y]
    # plot_labels: ['g', 'r', 'i', 'z', 'y']
    # plot_colors: ['green','red','blue','gray','yellow']
    # plot_styles: ['solid','solid','solid','solid','solid']

    # num_bands: 10
    # sensor_collection_name: '10'
    # filter_ids: [0,1,2,3,4,5,6,7,8,9]
    # filters: [g,r,i,z,y,nb387,nb816,nb921,u,us]
    # sensors_full_name: [HSC-G,HSC-R,HSC-I,HSC-Z,HSC-Y,NB0387,NB0816,NB0921,u,uS]
    # plot_labels: ['g', 'r', 'i', 'z', 'y', 'nb387', 'nb816', 'nb921','u','u*']
    # plot_colors: ['green','red','blue','gray','yellow','gray','red','blue','yellow','blue']
    # plot_styles: ['solid','solid','solid','solid','solid','dashed','dashed','dashed','dashdot','dashdot']

    plot_trans: True
    trans_sample_method: 'mixture'
    trans_threshold: 1e-4
    hardcode_num_trans_samples: 12
    trans_sample_interval: 10

spectra_data:
    download_source_spectra: False
    source_spectra_fname: "source_deimos_table_v7_different_wave_range_exclude_0_flux.tbl"
    source_spectra_link: "https://irsa.ipac.caltech.edu/data/COSMOS/spectra/deimos/spec1d_tbl"
    spectra_data_format: "tbl"
    spectra_data_source: "deimos"
    max_spectra_len: 8191 # hardcoded

    num_gt_spectra_upper_bound: 7000  # #spectra to load
    num_supervision_spectra_upper_bound: 7000
    val_spectra_ratio: 0.8
    source_spectra_cho: "" #"6000_to_8000"

    # **** Below fields should be modified together ****
    spectra_tracts: ['9569','9570','9571','9572','9812','9813','9814','10054','10055','10056']
    spectra_patches_r: ['0','1','2','3','4','5','6','7','8']
    spectra_patches_c: ['0','1','2','3','4','5','6','7','8']

    convolve_spectra: True
    spectra_smooth_sigma: 50
    processed_spectra_cho: "v7_table"
    # **************************************************

    spectra_supervision_wave_lo: 6000
    spectra_supervision_wave_hi: 8000
    codebook_spectra_plot_wave_lo: 6000 #2000
    codebook_spectra_plot_wave_hi: 8000 #10000
    load_spectra_data_from_cache: True
    # debug1: 300 spectra [9812][0,1][0-8] normed
    # debug2: 30 spectra [9812][0][0,1,2] normed

inpaint:
    inpaint_cho: 'no_inpaint' #'spectral_inpaint'
    inpaint_sample_ratio: 0.01 # 0-1
    plot_masked_gt: True

    # assume max set is 10 bands in this order [GRIZY,nb387,nb816,nb921,u,us]
    # always makes sure mask creation is called for a continuous set of bands
    # if train and inpaint bands dont form a continuous seq e.g. (train [1R,8u], inpaint [8u])
    # set mask band to any set of continuous bands that include current train and inpaint bands,
    # preferrably something like [0,1,2,3,4,5,6,7,8].
    # When do masking, pick only 1 and 8 channel from the full mask

    # define mask directory
    mask_mode: 'rand_same'
    mask_bandset_cho: '5grizy' # *change everytime
    mask_seed: 0              # seed to do random masking

    # define current train and inpaint bands (only used by spectral inpainting)
    # for us band, we use mask created for all 10 bands, where us is 9th train_bands: [0,1,3,4,5,6,8]
    #train_bands: [0,1,3,4,5,6,8]
    #inpaint_bands: [2,7,9]
    #relative_train_bands: [0,1,3,4,5,6,8]
    #relative_inpaint_bands: [2,7,9]
    train_bands: [0,2,3,4]
    inpaint_bands: [1]
    relative_train_bands: [0,2,3,4]
    relative_inpaint_bands: [1]